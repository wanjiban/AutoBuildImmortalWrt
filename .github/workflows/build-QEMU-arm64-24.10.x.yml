name: build-QEMU-armsr-armv8-24.10.x
# ‰Ω†ÂèØ‰ª•ÁêÜËß£‰∏∫ËøôÊòØ‰∏ÄÁßçARM64Âπ≥Âè∞‰∏ãÈÄöÁî®ÂûãOpenWrt ,‰∫ßÂá∫Ê†ºÂºè‰∏∫qcow2,ÈÄÇÂêàÊâÄÊúâARM64Âπ≥Âè∞ÁöÑËôöÊãüÊú∫
# ÊØîÂ¶ÇÊñêËÆØN1Âà∑‰∫ÜarmbianÁ≥ªÁªü,armbianÁ≥ªÁªüÈáåÂÆâË£Ö‰∫ÜPVEËôöÊãüÊú∫ ÂèØÁî®
# ÊØîÂ¶ÇÊñ∞Ê¨æApple SiliconËäØÁâáÁöÑËãπÊûúÁîµËÑëÈáåÁöÑËôöÊãüÊú∫UTM ÂèØÁî®
# ÊØîÂ¶ÇÂèãÂñÑNanoPi R3S„ÄÅR5S ÂÆòÊñπÊé®Âá∫ÁöÑÈ¢ÑË£Ö‰∫ÜPVEÁöÑdebianÁ≥ªÁªü ÂèØÁî®
# ÊØîÂ¶ÇÁëûËééE20CÂà∑‰∫ÜArmbianÁ≥ªÁªüÔºåËá™Â∑±ÂÆâË£Ö‰∫ÜQEMU+KVMËôöÊãüÊú∫ ÂèØÁî®
on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "ÈÄâÊã©luciÁâàÊú¨"
        required: false
        default: "24.10.4"
        type: choice
        options:
          - 24.10.0
          - 24.10.1
          - 24.10.2
          - 24.10.3
          - 24.10.4
      profile:
        type: choice
        description: |
          ÂèØÁî®‰∫éARM64ËôöÊãüÊú∫(ÊØîÂ¶ÇmacOS‰∏ãÁöÑUTMËôöÊãüÊú∫ ÊØîÂ¶ÇÊñêËÆØN1/R3S/R5SÁ≠âarm64Á≥ªÁªüÁöÑPVEËôöÊãüÊú∫)
        options:
          - generic
        required: true
        default: 'generic'
      rootfs_partsize:
        description: 'ËÆæÁΩÆËΩØ‰ª∂ÂåÖÂ§ßÂ∞è Âçï‰Ωç(MB) ÊúÄÂ§ßÊï∞ÂÄº10240'
        required: true
        default: '2048'
      enable_store:
        description: "ÈõÜÊàê store ÂïÜÂ∫ó"
        required: false
        type: boolean
        default: false
      enable_pppoe:
        description: "ÊòØÂê¶ÈÖçÁΩÆPPPoEÊã®Âè∑‰ø°ÊÅØ?"
        required: true
        default: 'no'
        type: choice
        options:
        - 'yes'
        - 'no'
      pppoe_account:
        description: "ÂÆΩÂ∏¶Ë¥¶Âè∑ (Ëã•ÂêØÁî®PPPoE)"
        required: false
      pppoe_password:
        description: "ÂÆΩÂ∏¶ÂØÜÁ†Å (Ëã•ÂêØÁî®PPPoE)"
        required: false
      include_docker:
        description: |
          ÊòØÂê¶ÁºñËØë Docker Êèí‰ª∂
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set executable permissions
        run: chmod +x ${{ github.workspace }}/armsr-armv8/build.sh
      
      - name: Enable Store integration
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
            echo "‚úÖ Â∑≤ËøΩÂä† luci-app-store"
          else
            echo "‚ùé Êú™ÂêØÁî® luci-app-store"
          fi
      
      - name: Validate PPPoE Inputs
        run: |
          if [[ "${{ inputs.enable_pppoe }}" == "yes" ]]; then
            if [[ -z "${{ inputs.pppoe_account }}" || -z "${{ inputs.pppoe_password }}" ]]; then
              echo "Error: PPPoE account and password must be provided when PPPoE is enabled!"
              exit 1
            fi
          fi
      
      - name: Building armsr-armv8 QEMU ImmortalWrt
        run: |
          profiles="${{ github.event.inputs.profile }}"
          rootfs_partsize="${{ github.event.inputs.rootfs_partsize }}"
          luci_version="${{ github.event.inputs.luci_version }}"
          
          IFS=',' read -r -a profile_array <<< "$profiles"
          
          for profile in "${profile_array[@]}"; do
            echo "Building for profile: $profile"
            
            docker run --rm -i \
              --user root \
              -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
              -v "${{ github.workspace }}/files/etc/uci-defaults:/home/build/immortalwrt/files/etc/uci-defaults" \
              -v "${{ github.workspace }}/arch/arch.conf:/home/build/immortalwrt/files/etc/opkg/arch.conf" \
              -v "${{ github.workspace }}/armsr-armv8/imm.config:/home/build/immortalwrt/.config" \
              -v "${{ github.workspace }}/shell:/home/build/immortalwrt/shell" \
              -v "${{ github.workspace }}/armsr-armv8/build.sh:/home/build/immortalwrt/build.sh" \
              -e PROFILE=$profile \
              -e ROOTFS_PARTSIZE=$rootfs_partsize \
              -e ENABLE_PPPOE=${{ inputs.enable_pppoe }} \
              -e PPPOE_ACCOUNT=${{ inputs.pppoe_account }} \
              -e PPPOE_PASSWORD=${{ inputs.pppoe_password }} \
              immortalwrt/imagebuilder:armsr-armv8-openwrt-${luci_version} /bin/bash /home/build/immortalwrt/build.sh
          done
          
      - name: Copy Firmware to workspace
        run: |
          cp ${{ github.workspace }}/bin/targets/armsr/armv8/*.qcow2 ${{ github.workspace }}
          cp ${{ github.workspace }}/bin/targets/armsr/armv8/*.vmdk ${{ github.workspace }}

      - name: Generate UTM package (ÂèÇËÄÉ mikrotik4UTM)
        run: |
          echo "=== ÁîüÊàê UTM ÂåÖ ==="

          # Êü•Êâæ qcow2 Êñá‰ª∂
          QCOW2_FILE=$(ls ${{ github.workspace }}/*.qcow2 2>/dev/null | head -1)
          if [ -z "$QCOW2_FILE" ]; then
            echo "‚ùå Êú™ÊâæÂà∞ qcow2 Êñá‰ª∂"
            exit 1
          fi
          echo "üì¶ ÊâæÂà∞ qcow2 Êñá‰ª∂: $QCOW2_FILE"

          # Ëé∑ÂèñÊñá‰ª∂ÂêçÔºà‰∏çÂê´Ë∑ØÂæÑÔºâ
          QCOW2_NAME=$(basename "$QCOW2_FILE")
          echo "üì¶ Êñá‰ª∂Âêç: $QCOW2_NAME"

          # Ëé∑Âèñ luci_version ‰Ωú‰∏∫ÁâàÊú¨Âè∑
          LUCI_VERSION="${{ github.event.inputs.luci_version }}"
          echo "üì¶ ÁâàÊú¨: $LUCI_VERSION"

          # UTM ÂåÖÂêç
          UTM_NAME="ImmortalWrt-${LUCI_VERSION}.utm"
          echo "üì¶ UTM ÂåÖÂêç: $UTM_NAME"

          # ÂàõÂª∫ UTM ÂåÖÁõÆÂΩï
          mkdir -p "${{ github.workspace }}/${UTM_NAME}/Data"
          echo "‚úÖ ÂàõÂª∫ UTM ÁõÆÂΩï: $UTM_NAME/Data"

          # ÁîüÊàêÈöèÊú∫ÂÄºÔºàÂèÇËÄÉ mikrotik4UTMÔºâ
          DRIVE_UUID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          VM_UUID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          VM_NAME="ImmortalWrt-${LUCI_VERSION}"

          # ÁîüÊàêÈöèÊú∫ MAC Âú∞ÂùÄÔºà‰ª• e2 ÂºÄÂ§¥ÔºåÁ¨¶Âêà UTM ÊÉØ‰æãÔºåÂÆåÊï¥6ÊÆµÔºâ
          MAC_ADDRESS=$(printf 'E2:%02x:%02x:%02x:%02x:%02x' $((RANDOM%256)) $((RANDOM%256)) $((RANDOM%256)) $((RANDOM%256)) $((RANDOM%256)))

          echo "üîë DRIVE_UUID: $DRIVE_UUID"
          echo "üîë VM_UUID: $VM_UUID"
          echo "üîë VM_NAME: $VM_NAME"
          echo "üîë MAC_ADDRESS: $MAC_ADDRESS"

          # ÂÆâË£ÖÂ∑•ÂÖ∑
          sudo apt-get update
          sudo apt-get install -y qemu-utils gzip curl

          # ËΩ¨Êç¢ qcow2 ‰∏∫ raw img
          IMG_NAME="${QCOW2_NAME%.qcow2}.img"
          qemu-img convert -f qcow2 -O raw "$QCOW2_FILE" "${{ github.workspace }}/${UTM_NAME}/Data/${IMG_NAME}"
          echo "‚úÖ ËΩ¨Êç¢ qcow2 ‰∏∫ img: $IMG_NAME"

          # ÂéãÁº© img
          gzip -f "${{ github.workspace }}/${UTM_NAME}/Data/${IMG_NAME}"
          IMG_GZ_NAME="${IMG_NAME}.gz"
          echo "‚úÖ ÂéãÁº© img ‰∏∫ img.gz"

          # ‰∏ãËΩΩ efi_vars.fd
          curl -sL "https://raw.githubusercontent.com/wanjiban/mikrotik4UTM/elseif/Files/efi_vars.fd" -o "${{ github.workspace }}/${UTM_NAME}/Data/efi_vars.fd"
          echo "‚úÖ ‰∏ãËΩΩ efi_vars.fd"

          # ‰∏ãËΩΩÂõæÊ†á
          curl -sL "https://raw.githubusercontent.com/wanjiban/mikrotik4UTM/elseif/Templates/mikrotik.svg" -o "${{ github.workspace }}/${UTM_NAME}/Data/icon.svg" 2>/dev/null || \
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128"><rect fill="#e74c3c" width="128" height="128" rx="20"/><text x="64" y="80" font-size="60" fill="white" text-anchor="middle" font-family="sans-serif">W</text></svg>' > "${{ github.workspace }}/${UTM_NAME}/Data/icon.svg"
          echo "‚úÖ ‰∏ãËΩΩÂõæÊ†á"

          # ÁîüÊàê config.plistÔºà‰ΩøÁî® base64 ÈÅøÂÖç YAML Ëß£ÊûêÈóÆÈ¢òÔºâ
          PLIST_CONTENT="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCFET0NUWVBFIHN2ZyBQVUJMSUMgIi0vL1czQy8vRFREIFNWRyAxLjEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvRkhMRy8xLjEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvUkhMRy8xLjEvL0VOIiBwbGlzdCB2ZXJzaW9uPSIxLjAiPjxkaWN0PjxrZXk+QmFja2VuZTwva2V5PjxzdHJpbmc+UVVNVTwvc3RyaW5nPjxrZXk+Q29uZmlndXJhdGlvblZlcnNpb248L2tleT48aW50ZWdlcj40PC9pbnRlZ2VyPjxrZXk+RGlzcGxheTwva2V5PjxhcnJheS8+PGtleT5Ecml2ZTwva2V5PjxhcnJheT48ZGljdD48a2V5PklkZW50aWZpZXI8L2tleT48c3RyaW5nPiRIT1JFX1VVSURfQTwvc3RyaW5nPjxrZXk+SW1hZ2VOYW1lPC9rZXk+PHN0cmluZz5JTUdfTkFNRV8wPC9zdHJpbmc+PGtleT5JbWFnZVR5cGU8L2tleT48c3RyaW5nPkRpc2s8L3N0cmluZz48a2V5PkludGVyZmFjZTwva2V5PjxzdHJpbmc+VmlydElPPC9zdHJpbmc+PGtleT5JbnRlcmZhY2VWZXJzaW9uPC9rZXk+PGludGVnZXI+MTwvaW50ZWdlcj48a2V5PlJlYWRPbmx5PC9rZXk+PGZhbHNlLz48L2RpY3Q+PC9hcnJheT48a2V5PkluZm9ybWF0aW9uPC9rZXk+PGRpY3Q+PGtleT5JY29uPC9rZXk+PHN0cmluZ0lPUzwvc3RyaW5nPjxrZXk+SWNvbkN1c3RvbTwva2V5PjxmYWxzZS8+PGtleT5OYW1lPC9rZXk+PHN0cmluZz5WTV9OQU1FXzA8L3N0cmluZz48a2V5Pk5vdGVzPC9rZXk+PHN0cmluZz48L3N0cmluZz48a2V5PlVVSURfMDwva2V5PjxzdHJpbmc+Vk1fVVVJRF8wPC9zdHJpbmc+PC9kaWN0PjxrZXk+SW5wdXQ8L2tleT48ZGljdC8+PGtleT5OZXR3b3JrPC9rZXk+PGFycmF5PjxkaWN0PjxrZXk+TW9kZTwva2V5PjxzdHJpbmc+QnJpZGdlZDwvc3RyaW5nPjxrZXk+TUFDX0FERFJFUzA8L2tleT48c3RyaW5nPk1BQ19BRERSRVNfMDwvc3RyaW5nPjxrZXk+SGFyZHdhcmU8L2tleT48c3RyaW5nPnZteG5ldDM8L3N0cmluZz48a2V5PkJyaWRnZUludGVyZmFjZTwva2V5PjxzdHJpbmc+PC9zdHJpbmc+PGtleT5Qb3J0Rm9yd2FyZDwva2V5PjxhcnJheS8+PC9kaWN0PjwvYXJyYXk+PGtleT5RVU1NPC9rZXk+PGRpY3Q+PGtleT5VRUZJQm9vdDwva2V5Pjx0cnVlLz48a2V5PlRhcmdldDwva2V5PjxzdHJpbmc+dmlydDwvc3RyaW5nPjxrZXk+Q1BVPC9rZXk+PHN0cmluZz5jb3J0ZXgtYTcyPC9zdHJpbmc+PGtleT5DUFBDb3VudDwva2V5PjxpbnRlZ2VyPjQ8L2ludGVnZXI+PGtleT5NZW1vcnlTaXplPC9rZXk+PGludGVnZXI+NTEyPC9pbnRlZ2VyPjwvZGljdD48a2V5PlNlcmlhbDwva2V5PjxhcnJheT48ZGljdD48a2V5PlRhcmdldDwva2V5PjxzdHJpbmc+QXV0bzwvc3RyaW5nPjwvZGljdD48L2FycmF5PjxrZXk+U2hhcmluZzwva2V5PjxkaWN0Lz48a2V5PlNvdW5kPC9rZXk+PGFycmF5Lz48a2V5PlN5c3RlbTwva2V5PjxkaWN0PjxrZXk+QXJjaGl0ZWN0dXJlPC9rZXk+PHN0cmluZz5hYXJjaDY0PC9zdHJpbmc+PGtleT5DUFU8L2tleT48c3RyaW5nPmNvcnRleC1hNzI8L3N0cmluZz48a2V5PkNQUENvdW50PC9rZXk+PGludGVnZXI+NDwvaW50ZWdlcj48a2V5PkpJVENhY2hlU2l6ZTwva2V5PjxpbnRlZ2VyPjA8L2ludGVnZXI+PGtleT5NZW1vcnlTaXplPC9rZXk+PGludGVnZXI+NTEyPC9pbnRlZ2VyPjxrZXk+VGFyZ2V0PC9rZXk+PHN0cmluZz52aXJ0PC9zdHJpbmc+PC9kaWN0PjwvZGljdD48L3BsaXN0Pg=="
          echo "$PLIST_CONTENT" | base64 -d > "${{ github.workspace }}/${UTM_NAME}/config.plist"
          echo "‚úÖ ÁîüÊàê config.plist"

           # ÊõøÊç¢Âç†‰ΩçÁ¨¶
           sed -i "s|HORE_UUID_A|${DRIVE_UUID}|g" "${{ github.workspace }}/${UTM_NAME}/config.plist"
           sed -i "s|IMG_NAME_|${IMG_GZ_NAME}|g" "${{ github.workspace }}/${UTM_NAME}/config.plist"
           sed -i "s|VM_NAME_|${VM_NAME}|g" "${{ github.workspace }}/${UTM_NAME}/config.plist"
           sed -i "s|MAC_ADDRES_|${MAC_ADDRESS}|g" "${{ github.workspace }}/${UTM_NAME}/config.plist"
           sed -i "s|VM_UUID_|${VM_UUID}|g" "${{ github.workspace }}/${UTM_NAME}/config.plist"

          # ÊòæÁ§∫ UTM ÂåÖÁªìÊûÑ
          echo "=== UTM ÂåÖÁªìÊûÑ ==="
          find "${{ github.workspace }}/${UTM_NAME}" -type f

          # ÊâìÂåÖÊàê zip
          cd "${{ github.workspace }}"
          zip -r "${UTM_NAME}.zip" "${UTM_NAME}"
          echo "‚úÖ ÁîüÊàê zip ÂåÖ: ${UTM_NAME}.zip"

          # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂Ôºà‰øùÁïô zipÔºâ
          rm -rf "${{ github.workspace }}/${UTM_NAME}"
          echo "‚úÖ Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂"

          # ÂàóÂá∫‰∫ßÁâ©
          echo "=== ÊâÄÊúâ‰∫ßÁâ© ==="
          ls -lh *.utm.zip *.qcow2 *.vmdk 2>/dev/null

      - name: Upload ImmortWrt as release assets
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: QEMU
          name: ImmortWrt-QEMU-armsr-armv8
          body_path: ${{ github.workspace }}/armsr-armv8/info.md
          files: |
            ${{ github.workspace }}/*.qcow2
            ${{ github.workspace }}/*.vmdk
            ${{ github.workspace }}/*.utm.zip
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
