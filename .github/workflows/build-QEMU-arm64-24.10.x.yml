name: build-QEMU-armsr-armv8-24.10.x
# ‰Ω†ÂèØ‰ª•ÁêÜËß£‰∏∫ËøôÊòØ‰∏ÄÁßçARM64Âπ≥Âè∞‰∏ãÈÄöÁî®ÂûãOpenWrt ,‰∫ßÂá∫Ê†ºÂºè‰∏∫qcow2,ÈÄÇÂêàÊâÄÊúâARM64Âπ≥Âè∞ÁöÑËôöÊãüÊú∫
# ÊØîÂ¶ÇÊñêËÆØN1Âà∑‰∫ÜarmbianÁ≥ªÁªü,armbianÁ≥ªÁªüÈáåÂÆâË£Ö‰∫ÜPVEËôöÊãüÊú∫ ÂèØÁî®
# ÊØîÂ¶ÇÊñ∞Ê¨æApple SiliconËäØÁâáÁöÑËãπÊûúÁîµËÑëÈáåÁöÑËôöÊãüÊú∫UTM ÂèØÁî®
# ÊØîÂ¶ÇÂèãÂñÑNanoPi R3S„ÄÅR5S ÂÆòÊñπÊé®Âá∫ÁöÑÈ¢ÑË£Ö‰∫ÜPVEÁöÑdebianÁ≥ªÁªü ÂèØÁî®
# ÊØîÂ¶ÇÁëûËééE20CÂà∑‰∫ÜArmbianÁ≥ªÁªüÔºåËá™Â∑±ÂÆâË£Ö‰∫ÜQEMU+KVMËôöÊãüÊú∫ ÂèØÁî®
on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "ÈÄâÊã©luciÁâàÊú¨"
        required: false
        default: "24.10.4"
        type: choice
        options:
          - 24.10.0
          - 24.10.1
          - 24.10.2
          - 24.10.3
          - 24.10.4
      profile:
        type: choice
        description: |
          ÂèØÁî®‰∫éARM64ËôöÊãüÊú∫(ÊØîÂ¶ÇmacOS‰∏ãÁöÑUTMËôöÊãüÊú∫ ÊØîÂ¶ÇÊñêËÆØN1/R3S/R5SÁ≠âarm64Á≥ªÁªüÁöÑPVEËôöÊãüÊú∫)
        options:
          - generic
        required: true
        default: 'generic'
      rootfs_partsize:
        description: 'ËÆæÁΩÆËΩØ‰ª∂ÂåÖÂ§ßÂ∞è Âçï‰Ωç(MB) ÊúÄÂ§ßÊï∞ÂÄº10240'
        required: true
        default: '2048'
      enable_store:
        description: "ÈõÜÊàê store ÂïÜÂ∫ó"
        required: false
        type: boolean
        default: false
      enable_pppoe:
        description: "ÊòØÂê¶ÈÖçÁΩÆPPPoEÊã®Âè∑‰ø°ÊÅØ?"
        required: true
        default: 'no'
        type: choice
        options:
        - 'yes'
        - 'no'
      pppoe_account:
        description: "ÂÆΩÂ∏¶Ë¥¶Âè∑ (Ëã•ÂêØÁî®PPPoE)"
        required: false
      pppoe_password:
        description: "ÂÆΩÂ∏¶ÂØÜÁ†Å (Ëã•ÂêØÁî®PPPoE)"
        required: false
      include_docker:
        description: |
          ÊòØÂê¶ÁºñËØë Docker Êèí‰ª∂
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set executable permissions
        run: chmod +x ${{ github.workspace }}/armsr-armv8/build.sh
      
      - name: Enable Store integration
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
            echo "‚úÖ Â∑≤ËøΩÂä† luci-app-store"
          else
            echo "‚ùé Êú™ÂêØÁî® luci-app-store"
          fi
      
      - name: Validate PPPoE Inputs
        run: |
          if [[ "${{ inputs.enable_pppoe }}" == "yes" ]]; then
            if [[ -z "${{ inputs.pppoe_account }}" || -z "${{ inputs.pppoe_password }}" ]]; then
              echo "Error: PPPoE account and password must be provided when PPPoE is enabled!"
              exit 1
            fi
          fi
      
      - name: Building armsr-armv8 QEMU ImmortalWrt
        run: |
          profiles="${{ github.event.inputs.profile }}"
          rootfs_partsize="${{ github.event.inputs.rootfs_partsize }}"
          luci_version="${{ github.event.inputs.luci_version }}"
          
          IFS=',' read -r -a profile_array <<< "$profiles"
          
          for profile in "${profile_array[@]}"; do
            echo "Building for profile: $profile"
            
            docker run --rm -i \
              --user root \
              -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
              -v "${{ github.workspace }}/files/etc/uci-defaults:/home/build/immortalwrt/files/etc/uci-defaults" \
              -v "${{ github.workspace }}/arch/arch.conf:/home/build/immortalwrt/files/etc/opkg/arch.conf" \
              -v "${{ github.workspace }}/armsr-armv8/imm.config:/home/build/immortalwrt/.config" \
              -v "${{ github.workspace }}/shell:/home/build/immortalwrt/shell" \
              -v "${{ github.workspace }}/armsr-armv8/build.sh:/home/build/immortalwrt/build.sh" \
              -e PROFILE=$profile \
              -e ROOTFS_PARTSIZE=$rootfs_partsize \
              -e ENABLE_PPPOE=${{ inputs.enable_pppoe }} \
              -e PPPOE_ACCOUNT=${{ inputs.pppoe_account }} \
              -e PPPOE_PASSWORD=${{ inputs.pppoe_password }} \
              immortalwrt/imagebuilder:armsr-armv8-openwrt-${luci_version} /bin/bash /home/build/immortalwrt/build.sh
          done
          
      - name: Copy Firmware to workspace
        run: |
          cp ${{ github.workspace }}/bin/targets/armsr/armv8/*.qcow2 ${{ github.workspace }}
          cp ${{ github.workspace }}/bin/targets/armsr/armv8/*.vmdk ${{ github.workspace }}
          cp ${{ github.workspace }}/bin/targets/armsr/armv8/*.img.gz ${{ github.workspace }}

      - name: Generate UTM package
        run: |
          echo "=== ÁîüÊàê UTM Ê†ºÂºè ==="
          
          # Êü•Êâæ qcow2 Êñá‰ª∂
          QCOW2_FILE=$(ls ${{ github.workspace }}/*.qcow2 2>/dev/null | head -1)
          if [ -z "$QCOW2_FILE" ]; then
            echo "‚ùå Êú™ÊâæÂà∞ qcow2 Êñá‰ª∂"
            exit 1
          fi
          echo "üì¶ ÊâæÂà∞ qcow2 Êñá‰ª∂: $QCOW2_FILE"
          
          # Ëé∑ÂèñÊñá‰ª∂ÂêçÔºà‰∏çÂê´Ë∑ØÂæÑÔºâ
          QCOW2_NAME=$(basename "$QCOW2_FILE")
          echo "üì¶ Êñá‰ª∂Âêç: $QCOW2_NAME"
          
          # Ëé∑Âèñ luci_version ‰Ωú‰∏∫ÁâàÊú¨Âè∑
          LUCI_VERSION="${{ github.event.inputs.luci_version }}"
          echo "üì¶ ÁâàÊú¨: $LUCI_VERSION"
          
          # UTM ÂåÖÂêç
          UTM_NAME="ImmortalWrt-${LUCI_VERSION}.utm"
          echo "üì¶ UTM ÂåÖÂêç: $UTM_NAME"
          
          # ÂàõÂª∫ UTM ÂåÖÁõÆÂΩï
          mkdir -p "${{ github.workspace }}/${UTM_NAME}/Data"
          echo "‚úÖ ÂàõÂª∫ UTM ÁõÆÂΩï: $UTM_NAME/Data"
          
          # Â§çÂà∂ efi_vars.fd
          cp ${{ github.workspace }}/armsr-armv8/efi_vars.fd "${{ github.workspace }}/${UTM_NAME}/Data/"
          echo "‚úÖ Â§çÂà∂ efi_vars.fd"
          
          # Â§çÂà∂ qcow2 Âà∞ Data ÁõÆÂΩï
          cp "$QCOW2_FILE" "${{ github.workspace }}/${UTM_NAME}/Data/"
          echo "‚úÖ Â§çÂà∂ qcow2 Âà∞ Data ÁõÆÂΩï"
          
          # ÁîüÊàê config.plistÔºàÊõøÊç¢ÈïúÂÉèÊñá‰ª∂ÂêçÔºâ
          sed "s|immortalwrt-24.10.2-armsr-armv8-generic-squashfs-combined-efi (1).qcow2|${QCOW2_NAME}|g" \
            ${{ github.workspace }}/armsr-armv8/config.plist.sample.plist > "${{ github.workspace }}/${UTM_NAME}/config.plist"
          echo "‚úÖ ÁîüÊàê config.plist"
          
          # ÁîüÊàêÂõæÊ†á (SVG base64 -> file)
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128"><rect fill="#e74c3c" width="128" height="128" rx="20"/><text x="64" y="80" font-size="60" fill="white" text-anchor="middle" font-family="sans-serif">W</text></svg>' > "${{ github.workspace }}/${UTM_NAME}/Data/icon.svg"
          echo "‚úÖ ÁîüÊàêÂõæÊ†á"
          
          # ÊòæÁ§∫ UTM ÂåÖÁªìÊûÑ
          echo "=== UTM ÂåÖÁªìÊûÑ ==="
          find "${{ github.workspace }}/${UTM_NAME}" -type f
          
          # ÊâìÂåÖÊàê zipÔºàÊñπ‰æø‰∏ãËΩΩÔºâ
          cd "${{ github.workspace }}"
          zip -r "${UTM_NAME}.zip" "${UTM_NAME}"
          echo "‚úÖ ÁîüÊàê zip ÂåÖ: ${UTM_NAME}.zip"
          
          # ÂàóÂá∫ÊâÄÊúâ‰∫ßÁâ©
          echo "=== ÊâÄÊúâ‰∫ßÁâ© ==="
          ls -lh *.qcow2 *.utm.zip 2>/dev/null || ls -lh *.qcow2 *.utm 2>/dev/null

      - name: Upload ImmortWrt as release assets
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: QEMU
          name: ImmortWrt-QEMU-armsr-armv8
          body_path: ${{ github.workspace }}/armsr-armv8/info.md
          files: |
            ${{ github.workspace }}/*.qcow2 
            ${{ github.workspace }}/*.vmdk
            ${{ github.workspace }}/*.img.gz
            ${{ github.workspace }}/*.utm.zip
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
