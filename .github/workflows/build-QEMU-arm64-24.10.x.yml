name: build-QEMU-armsr-armv8-24.10.x
# ä½ å¯ä»¥ç†è§£ä¸ºè¿™æ˜¯ä¸€ç§ARM64å¹³å°ä¸‹é€šç”¨å‹OpenWrt ,äº§å‡ºæ ¼å¼ä¸ºqcow2,é€‚åˆæ‰€æœ‰ARM64å¹³å°çš„è™šæ‹Ÿæœº
# æ¯”å¦‚æ–è®¯N1åˆ·äº†armbianç³»ç»Ÿ,armbianç³»ç»Ÿé‡Œå®‰è£…äº†PVEè™šæ‹Ÿæœº å¯ç”¨
# æ¯”å¦‚æ–°æ¬¾Apple SiliconèŠ¯ç‰‡çš„è‹¹æœç”µè„‘é‡Œçš„è™šæ‹ŸæœºUTM å¯ç”¨
# æ¯”å¦‚å‹å–„NanoPi R3Sã€R5S å®˜æ–¹æ¨å‡ºçš„é¢„è£…äº†PVEçš„debianç³»ç»Ÿ å¯ç”¨
# æ¯”å¦‚ç‘èE20Cåˆ·äº†Armbianç³»ç»Ÿï¼Œè‡ªå·±å®‰è£…äº†QEMU+KVMè™šæ‹Ÿæœº å¯ç”¨
on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: false
        default: "24.10.4"
        type: choice
        options:
          - 24.10.0
          - 24.10.1
          - 24.10.2
          - 24.10.3
          - 24.10.4
      profile:
        type: choice
        description: |
          å¯ç”¨äºARM64è™šæ‹Ÿæœº(æ¯”å¦‚macOSä¸‹çš„UTMè™šæ‹Ÿæœº æ¯”å¦‚æ–è®¯N1/R3S/R5Sç­‰arm64ç³»ç»Ÿçš„PVEè™šæ‹Ÿæœº)
        options:
          - generic
        required: true
        default: 'generic'
      rootfs_partsize:
        description: 'è®¾ç½®è½¯ä»¶åŒ…å¤§å° å•ä½(MB) æœ€å¤§æ•°å€¼10240'
        required: true
        default: '2048'
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: false
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: 'no'
        type: choice
        options:
        - 'yes'
        - 'no'
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false
      include_docker:
        description: |
          æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set executable permissions
        run: chmod +x ${{ github.workspace }}/armsr-armv8/build.sh
      
      - name: Enable Store integration
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
            echo "âœ… å·²è¿½åŠ  luci-app-store"
          else
            echo "â æœªå¯ç”¨ luci-app-store"
          fi
      
      - name: Validate PPPoE Inputs
        run: |
          if [[ "${{ inputs.enable_pppoe }}" == "yes" ]]; then
            if [[ -z "${{ inputs.pppoe_account }}" || -z "${{ inputs.pppoe_password }}" ]]; then
              echo "Error: PPPoE account and password must be provided when PPPoE is enabled!"
              exit 1
            fi
          fi
      
      - name: Building armsr-armv8 QEMU ImmortalWrt
        run: |
          profiles="${{ github.event.inputs.profile }}"
          rootfs_partsize="${{ github.event.inputs.rootfs_partsize }}"
          luci_version="${{ github.event.inputs.luci_version }}"
          
          IFS=',' read -r -a profile_array <<< "$profiles"
          
          for profile in "${profile_array[@]}"; do
            echo "Building for profile: $profile"
            
            docker run --rm -i \
              --user root \
              -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
              -v "${{ github.workspace }}/files/etc/uci-defaults:/home/build/immortalwrt/files/etc/uci-defaults" \
              -v "${{ github.workspace }}/arch/arch.conf:/home/build/immortalwrt/files/etc/opkg/arch.conf" \
              -v "${{ github.workspace }}/armsr-armv8/imm.config:/home/build/immortalwrt/.config" \
              -v "${{ github.workspace }}/shell:/home/build/immortalwrt/shell" \
              -v "${{ github.workspace }}/armsr-armv8/build.sh:/home/build/immortalwrt/build.sh" \
              -e PROFILE=$profile \
              -e ROOTFS_PARTSIZE=$rootfs_partsize \
              -e ENABLE_PPPOE=${{ inputs.enable_pppoe }} \
              -e PPPOE_ACCOUNT=${{ inputs.pppoe_account }} \
              -e PPPOE_PASSWORD=${{ inputs.pppoe_password }} \
              immortalwrt/imagebuilder:armsr-armv8-openwrt-${luci_version} /bin/bash /home/build/immortalwrt/build.sh
          done
          
      - name: Copy Firmware to workspace
        run: |
          cp ${{ github.workspace }}/bin/targets/armsr/armv8/*.qcow2 ${{ github.workspace }}
          cp ${{ github.workspace }}/bin/targets/armsr/armv8/*.vmdk ${{ github.workspace }}
          cp ${{ github.workspace }}/bin/targets/armsr/armv8/*.img.gz ${{ github.workspace }}

      - name: Generate UTM package
        run: |
          echo "=== ç”Ÿæˆ UTM æ ¼å¼ ==="
          
          # æŸ¥æ‰¾ qcow2 æ–‡ä»¶
          QCOW2_FILE=$(ls ${{ github.workspace }}/*.qcow2 2>/dev/null | head -1)
          if [ -z "$QCOW2_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° qcow2 æ–‡ä»¶"
            exit 1
          fi
          echo "ğŸ“¦ æ‰¾åˆ° qcow2 æ–‡ä»¶: $QCOW2_FILE"
          
          # è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰
          QCOW2_NAME=$(basename "$QCOW2_FILE")
          echo "ğŸ“¦ æ–‡ä»¶å: $QCOW2_NAME"
          
          # è·å– luci_version ä½œä¸ºç‰ˆæœ¬å·
          LUCI_VERSION="${{ github.event.inputs.luci_version }}"
          echo "ğŸ“¦ ç‰ˆæœ¬: $LUCI_VERSION"
          
          # UTM åŒ…å
          UTM_NAME="ImmortalWrt-${LUCI_VERSION}.utm"
          echo "ğŸ“¦ UTM åŒ…å: $UTM_NAME"
          
          # åˆ›å»º UTM åŒ…ç›®å½•
          mkdir -p "${{ github.workspace }}/${UTM_NAME}/Data"
          echo "âœ… åˆ›å»º UTM ç›®å½•: $UTM_NAME/Data"
          
          # ç”Ÿæˆéšæœºå€¼ï¼ˆå‚è€ƒ mikrotik4UTMï¼‰
          DRIVE_UUID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          VM_UUID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          VM_NAME="ImmortalWrt-${LUCI_VERSION}"
          
          # ç”Ÿæˆéšæœº MAC åœ°å€ï¼ˆä»¥ e2 å¼€å¤´ï¼Œç¬¦åˆ UTM æƒ¯ä¾‹ï¼‰
          MAC_PREFIX="E2"
          MAC_SUFFIX=$(printf '%02x%02x%02x' $((RANDOM%256)) $((RANDOM%256)) $((RANDOM%256)))
          MAC_ADDRESS="${MAC_PREFIX}:${MAC_SUFFIX:0:2}:${MAC_SUFFIX:2:2}:${MAC_SUFFIX:4:2}"
          
          echo "ğŸ”‘ DRIVE_UUID: $DRIVE_UUID"
          echo "ğŸ”‘ VM_UUID: $VM_UUID"
          echo "ğŸ”‘ VM_NAME: $VM_NAME"
          echo "ğŸ”‘ MAC_ADDRESS: $MAC_ADDRESS"
          
          # å¤åˆ¶ efi_vars.fd
          cp ${{ github.workspace }}/armsr-armv8/efi_vars.fd "${{ github.workspace }}/${UTM_NAME}/Data/"
          echo "âœ… å¤åˆ¶ efi_vars.fd"
          
          # å¤åˆ¶ qcow2 åˆ° Data ç›®å½•
          cp "$QCOW2_FILE" "${{ github.workspace }}/${UTM_NAME}/Data/"
          echo "âœ… å¤åˆ¶ qcow2 åˆ° Data ç›®å½•"
          
          # åŠ¨æ€ç”Ÿæˆ config.plistï¼ˆå‚è€ƒ mikrotik4UTMï¼‰
          sed -e "s|__IMAGE_NAME__|${QCOW2_NAME}|g" \
              -e "s|__VM_NAME__|${VM_NAME}|g" \
              -e "s|__VM_UUID__|${VM_UUID}|g" \
              -e "s|__DRIVE_UUID__|${DRIVE_UUID}|g" \
              -e "s|__MAC_ADDRESS__|${MAC_ADDRESS}|g" \
              -e "s|__ICON__|IOS|g" \
              ${{ github.workspace }}/armsr-armv8/config.plist.sample > "${{ github.workspace }}/${UTM_NAME}/config.plist"
          echo "âœ… ç”Ÿæˆ config.plist"
          
          # ç”Ÿæˆå›¾æ ‡ (SVG)
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128"><rect fill="#e74c3c" width="128" height="128" rx="20"/><text x="64" y="80" font-size="60" fill="white" text-anchor="middle" font-family="sans-serif">W</text></svg>' > "${{ github.workspace }}/${UTM_NAME}/Data/icon.svg"
          echo "âœ… ç”Ÿæˆå›¾æ ‡"
          
          # æ˜¾ç¤º UTM åŒ…ç»“æ„
          echo "=== UTM åŒ…ç»“æ„ ==="
          find "${{ github.workspace }}/${UTM_NAME}" -type f
          
          # æ‰“åŒ…æˆ zipï¼ˆæ–¹ä¾¿ä¸‹è½½ï¼‰
          cd "${{ github.workspace }}"
          zip -r "${UTM_NAME}.zip" "${UTM_NAME}"
          echo "âœ… ç”Ÿæˆ zip åŒ…: ${UTM_NAME}.zip"
          
          # åˆ—å‡ºæ‰€æœ‰äº§ç‰©
          echo "=== æ‰€æœ‰äº§ç‰© ==="
          ls -lh *.qcow2 *.utm.zip 2>/dev/null || ls -lh *.qcow2 *.utm 2>/dev/null

      - name: Upload ImmortWrt as release assets
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: QEMU
          name: ImmortWrt-QEMU-armsr-armv8
          body_path: ${{ github.workspace }}/armsr-armv8/info.md
          files: |
            ${{ github.workspace }}/*.qcow2 
            ${{ github.workspace }}/*.vmdk
            ${{ github.workspace }}/*.img.gz
            ${{ github.workspace }}/*.utm.zip
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
